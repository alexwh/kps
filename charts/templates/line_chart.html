{% load static %}
<html>
    <head>
        <title>django-chartjs line chart demo</title>
        <!--[if lte IE 8]>
            <script src="{% static 'js/excanvas.js' %}"></script>
        <![endif]-->
        <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script> -->
        <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.bundle.min.js" integrity="sha512-SuxO9djzjML6b9w9/I07IWnLnQhgyYVSpHZx0JV97kGBfTIsUYlWflyuW4ypnvhBrslz1yJ3R+S14fdCWmSmSA==" crossorigin="anonymous"></script> -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.js" integrity="sha512-WNLxfP/8cVYL9sj8Jnp6et0BkubLP31jhTG9vhL/F5uEZmg5wEzKoXp1kJslzPQWwPT1eyMiSxlKCgzHLOTOTQ==" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.bundle.js" integrity="sha512-zO8oeHCxetPn1Hd9PdDleg5Tw1bAaP0YmNvPY8CwcRyUk7d7/+nyElmFrB6f7vg4f7Fv4sui1mcep8RIEShczg==" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@0.7.7/dist/chartjs-plugin-zoom.min.js" integrity="sha256-6S7w9Wue7EBvlJh/Li/cPecjTNN+yBm/AoCePQA9Xi8=" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js" integrity="sha256-eVNjHw5UeU0jUqPPpZHAkU1z4U+QFBBY488WvueTm88=" crossorigin="anonymous"></script>
    <style>
        #template {
            display:none;
        }
        select {
            width: 250px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
    </head>
    <body>
        <div id="controls">
            <input id="fetch_ytid"></input>
            <button id="fetch_new">fetch</button>
            <select id="ytid">
                {% for stream in db_streams %}
                <option value="{{ stream.stream_id }}">{{ stream.channel.name }} - {{ stream.title }}</option>
                {% endfor %}
            </select>
            <button id="add_template">add template keyword</button>
            <button id="get_the_goods">go</button>
            <div id="kw_container">
                <input id="template"></input>
            </div>
        </div>
        <div id="charts">
            <canvas id="myChart" width="800" height="600"></canvas>
        </div>
        <script type="text/javascript">
            $("#get_the_goods").on("click", function(event) {
                event.preventDefault();
                keyword_elements = $(".keywords");
                var keywords = [];
                $.each(keyword_elements, function(k, v) {
                    keywords.push(v.value);
                    console.log(k, v);
                })
                $.get('/cinfo/' + $("#ytid").val() + ".json", {"keywords": keywords}, function(resp) {
                    var ctx = $("#myChart").get(0).getContext("2d");
                    new Chart(ctx, {
                        type: 'line', data: resp.data, options: resp.options
                    });
                });
            })
            $("#add_template").on("click", function(event) {
                event.preventDefault();
                let kw = $("#template").clone();
                kw.removeAttr("id");
                kw.addClass("keywords");
                $("#kw_container").append(kw);
            })
            $("#fetch_new").on("click", function(event) {
                event.preventDefault();
                fetch_ytid = $("#fetch_ytid").val();
                var sock = new WebSocket('ws://' + window.location.host + '/ws/fetch/' + fetch_ytid + '/');
                sock.onmessage = function(m) {console.log(m)};
                sock.onopen = function(m) {
                    sock.send("gettem");
                };
                $("#fetch_new").value("fetching...");
            })
        </script>
    </body>
</html>
